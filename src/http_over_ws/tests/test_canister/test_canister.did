/* WebSocket types */
type ClientPrincipal = principal;
type GatewayPrincipal = principal;
type ClientKey = record {
    client_principal : ClientPrincipal;
    client_nonce : nat64;
};

type WebsocketMessage = record {
    client_key : ClientKey;
    sequence_num : nat64;
    timestamp : nat64;
    is_service_message : bool;
    content : blob;
};

type CanisterOutputMessage = record {
    client_key : ClientKey;
    key : text;
    content : blob;
};

type CanisterOutputCertifiedMessages = record {
    messages : vec CanisterOutputMessage;
    cert : blob;
    tree : blob;
    is_end_of_queue : bool;
};

type CanisterWsOpenArguments = record {
    client_nonce : nat64;
    gateway_principal : GatewayPrincipal;
};

type CanisterWsOpenResult = variant {
    Ok : null;
    Err : text;
};

type CanisterWsCloseArguments = record {
    client_key : ClientKey;
};

type CanisterWsCloseResult = variant {
    Ok : null;
    Err : text;
};

type CanisterWsMessageArguments = record {
    msg : WebsocketMessage;
};

type CanisterWsMessageResult = variant {
    Ok : null;
    Err : text;
};

type CanisterWsGetMessagesArguments = record {
    nonce : nat64;
};

type CanisterWsGetMessagesResult = variant {
    Ok : CanisterOutputCertifiedMessages;
    Err : text;
};
/* End WebSocket types */

/* HttpOverWs types */
type HttpConnectionId = nat32;

type HttpMethod = variant {
    GET;
    POST;
    PUT;
    HEAD;
    DELETE;
};

type HttpHeader = record {
    name : text;
    value : text;
};

type HttpOverWsError = variant {
    NotHttpOverWsType : text;
    InvalidHttpMessage : HttpFailureReason;
};

type HttpFailureReason = variant {
    RequestTimeout;
    ProxyError : text;
    ConnectionIdNotFound;
    NotYetReceived;
};

type HttpRequest = record {
    url : text;
    method : HttpMethod;
    headers : vec HttpHeader;
    body : opt blob;
};

type HttpRequestTimeoutMs = nat64;

type HttpResponse = record {
    status : nat;
    headers : vec HttpHeader;
    body : blob;
};

type GetHttpResponseResult = variant {
    Ok : HttpResponse;
    Err : HttpFailureReason;
};
/* End HttpOverWs types */

/* Application types */
type AppMessage = record {
    text : text;
};
/* End Application types */

service : () -> {
    "ws_open" : (CanisterWsOpenArguments) -> (CanisterWsOpenResult);
    "ws_close" : (CanisterWsCloseArguments) -> (CanisterWsCloseResult);
    "ws_message" : (CanisterWsMessageArguments, opt AppMessage) -> (CanisterWsMessageResult);
    "ws_get_messages" : (CanisterWsGetMessagesArguments) -> (CanisterWsGetMessagesResult) query;

    "execute_http_request" : (HttpRequest, opt HttpRequestTimeoutMs, bool) -> (HttpConnectionId, HttpOverWsError);
    "get_http_response" : (HttpConnectionId) -> (GetHttpResponseResult) query;
    "get_callback_responses" : () -> (vec HttpResponse) query;
};
